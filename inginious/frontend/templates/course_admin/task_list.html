$def with (course, course_structure, tasks, errors, validated)

$#
$# This file is part of INGInious. See the LICENSE and the COPYRIGHTS files for
$# more information about the licensing of this file.
$#

$var title: $:course.get_name(user_manager.session_language())

$var Column: $:template_helper.call('course_admin_menu',course=course,current='tasks')
$ is_admin = user_manager.has_admin_rights_on_course(course)

$def NavbarF():
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="$get_homepath()/course/$course.get_id()">$course.get_name(user_manager.session_language())</a></li>
            <li class="breadcrumb-item"><a href="$get_homepath()/admin/$course.get_id()" title=$:_('"Administration"') data-toggle="tooltip" data-placement="bottom">
                <i class="fa fa-user-secret"></i></a></li>
            <li class="breadcrumb-item active"><a href="#"><i class="fa fa-tasks"></i> $:_("Tasks") <span class="sr-only">$:_("(current)")</span></a></li>
        </ol>
    </nav>
$var Navbar: $:NavbarF()


<style>
    /* line for sections */
    .divided {
      display: flex;
      align-items: center;
    }
    .divider {
      flex-grow: 1;
      border-bottom: 1px solid lightgrey;
      margin: 5px
    }

    /* only display option applicable to the type of section */
    .sections_list_option { display: none; }
    .sections_list >div>div>div> .sections_list_option { display: block; }
</style>

<!-- Methods to print structure -->
$def print_section(sections, level):
    $for section in sections:
        $if section.is_empty():
            $:print_empty_section("section_" + section.get_id(), section.get_title(), level)
        $elif section.is_terminal():
            $:print_terminal_section(section, level)
        $else:
            $:print_non_terminal_section(section, level)

$# print a non terminal section and the sections it contains
$def print_non_terminal_section(section, level):
    <div id="section_$:_(section.get_id())" class="section sections_list mb-4" data-level="$:(level)">
        <div class="section_header handle d-flex justify-content-between divided pr-3">
            <span class="title h$level mr-3">
                $:_(section.get_title())
            </span>
            <span class="divider"></span>

            $:section_menu(False, True)
        </div>
        <div class="content ml-4">
            $:print_section(section.get_sections_list(), level +1)
        </div>
    </div>

$# print a terminal section and the tasks it contains
$def print_terminal_section(section, level):
    <div id="section_$:_(section.get_id())" class="section tasks_list card mb-4" data-level="$:(level)" >
        <div class="section_header handle card-header d-flex justify-content-between pr-3">
            <span class="title">
                $:_(section.get_title())
            </span>
            <span style="display: none" class="divider"></span>

            $:section_menu(True, False)
        </div>
        <div class="content list-group list-group-flush">
            $for taskid in section.get_tasks():
                $if taskid in tasks:
                    <div id="task_$:(taskid)" class="task handle list-group-item list-group-item-action d-flex">
                        <div class="task_name p-0">
                            $tasks[taskid]["name"]
                        </div>
                        <div class="ml-auto">
                            $:task_buttons(taskid)
                        </div>
                    </div>
                $else:
                    <div id="task_$:(taskid)" class="task handle list-group-item list-group-item-action d-flex bg-danger">
                        <div class="task_name p-0">
                            $_("No valid task with id:") $taskid
                        </div>
                        <div class="ml-auto">
                        </div>
                    </div>
        </div>
    </div>

$# print an empty section
$def print_empty_section(id, title, level, hidden=False):
    <div style="$('display: none' if hidden else 'display: block')" id="$:(id)" class="section tasks_list sections_list card mb-4" data-level="$:(level)">
        <div class="section_header handle card-header d-flex justify-content-between pr-3">
            <span class="title">
                $:(title)
            </span>
            <span style="display: none" class="divider"></span>
            $:section_menu(True, True)
        </div>
        <div data-level="0" class="content list-group list-group-flush">
            <p class="section_placeholder text-center align-middle m-2">
                $:_("This section is empty.")
            </p>
        </div>
    </div>

$def section_menu(tasks_list_option, sections_list_option):
    <div class="dropdown ml-3">
        <button type="button" style="font-size: 1.5rem;"
                class="button fa fa-bars close border-transparent" data-toggle="dropdown">
        </button>
        <div class="dropdown-menu dropdown-menu-right rounded">
            <a class="add_section sections_list_option dropdown-item" onclick="create_section($$(this).closest('.section'))">
                <i class="fa fa-plus"></i> $:_("Add subsection")
            </a>
            <a class="rename dropdown-item" onclick="rename_section($$(this).closest('.section_header').children('.title'))">
                <i class="fa fa-pencil"></i> $:_("Rename")
            </a>
        </div>
    </div>

$def task_buttons(taskid):
    <a class="rename_task btn bg-transparent p-0" href="$get_homepath()/admin/${course.get_id()}/edit/task/$taskid"
            title=$:_('"Edit task"') style="font-size: 1em;" data-toggle="tooltip" data-placement="bottom">
        <i class="fa fa-pencil text-muted "></i>
    </a>

<!-- Content -->
<div id="course_structure" data-level="2" class="sections_list pb-3">
    <h2>$:_("Tasks")</h2>

    $if errors:
        $for error in errors:
            <div class="alert alert-danger" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                $error
            </div>
    $elif validated:
        <div class="alert alert-success" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
            $:_("Change saved.")
        </div>

    <div class="content">
        $:print_section(course_structure, 3)
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <button class="btn btn-secondary btn-block" onclick="create_section($$('#course_structure'))">
            <i class="fa fa-plus"></i> $:_("Add section")
        </button>
    </div>
    <div class="col-md-4">
        <button class="btn btn-danger btn-block" onclick="location.reload()">
            <i class="fa fa-undo"></i> $:_("Cancel")
        </button>
    </div>
    <div class="col-md-4">
        <button class="btn btn-primary btn-block" onclick="submit();">
            <i class="fa fa-download"></i> $:_("Save changes")
        </button>
    </div>
</div>

<!-- Invisible element (for copy) -->
$:print_empty_section("empty_section", "New section",  0, hidden=True)
